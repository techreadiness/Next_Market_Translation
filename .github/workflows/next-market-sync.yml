name: Next-Market-English-Sync

on:
  push:
    paths:
      - 'ko/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: DeepL English Engine
        env:
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
        run: |
          TARGET_LANG="en"
          DEEPL_CODE="EN-US"

          if [ ! -d "ko" ]; then echo "ko 폴더 없음"; exit 0; fi

          find ko -name "*.md" | while read file; do
            REL_PATH=${file#ko/}
            TARGET_FILE="$TARGET_LANG/$REL_PATH"
            mkdir -p "$(dirname "$TARGET_FILE")"

            echo "번역 시작: $file"

            # 1. 원문 읽기
            CONTENT=$(cat "$file")

            # 2. 보호 조치 (Next Market + 이미지/링크 태그)
            # 고유명사 보호
            CONTENT=$(echo "$CONTENT" | sed 's/Next Market/<span translate="no">Next Market<\/span>/g')
            # 이미지 태그 보호 (![alt](path))
            CONTENT=$(echo "$CONTENT" | sed -E 's/(!\[[^]]*\]\([^)]*\))/<span translate="no">\1<\/span>/g')
            # 일반 링크 보호 ([text](path))
            CONTENT=$(echo "$CONTENT" | sed -E 's/([^!]\[[^]]*\]\([^)]*\))/<span translate="no">\1<\/span>/g')

            # 3. DeepL API 호출 (HTML 태그 핸들링 활성화)
            RESPONSE=$(curl -s -X POST "https://api-free.deepl.com/v2/translate" \
              -H "Authorization: DeepL-Auth-Key $DEEPL_API_KEY" \
              --data-urlencode "text=$CONTENT" \
              -d "source_lang=KO" \
              -d "target_lang=$DEEPL_CODE" \
              -d "tag_handling=html" \
              -d "non_splitting_tags=span")

            TRANSLATED=$(echo "$RESPONSE" | jq -r '.translations[0].text // empty')

            if [ -n "$TRANSLATED" ] && [ "$TRANSLATED" != "null" ]; then
              # 4. 보호용 span 태그 제거 (정규식으로 모든 span 태그 삭제)
              FINAL_CONTENT=$(echo "$TRANSLATED" | sed -E 's/<\/?span[^>]*>//g')
              echo "$FINAL_CONTENT" > "$TARGET_FILE"
            else
              echo "⚠️ 번역 실패: $file"
            fi
          done

      - name: Sync & Translate SUMMARY.md
        env:
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
        run: |
          if [ -f "ko/SUMMARY.md" ]; then
            # SUMMARY.md는 목차이므로 링크 구조가 중요함. 위와 동일한 로직 적용
            CONTENT=$(cat "ko/SUMMARY.md")
            CONTENT=$(echo "$CONTENT" | sed 's/Next Market/<span translate="no">Next Market<\/span>/g')
            CONTENT=$(echo "$CONTENT" | sed -E 's/(\[[^]]*\]\([^)]*\))/<span translate="no">\1<\/span>/g')
            
            RESPONSE=$(curl -s -X POST "https://api-free.deepl.com/v2/translate" \
              -H "Authorization: DeepL-Auth-Key $DEEPL_API_KEY" \
              --data-urlencode "text=$CONTENT" \
              -d "source_lang=KO" \
              -d "target_lang=EN-US" \
              -d "tag_handling=html")
            
            TRANSLATED=$(echo "$RESPONSE" | jq -r '.translations[0].text')
            echo "$TRANSLATED" | sed -E 's/<\/?span[^>]*>//g' > "en/SUMMARY.md"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add en/
          git commit -m "docs: Next Market 영어 번역 및 이미지 경로 보존" || echo "변경 없음"
          git push origin main
