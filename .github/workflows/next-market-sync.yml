name: Next-Market-Global-Sync

on:
  push:
    paths:
      - 'ko/**' # 한국어 폴더 내 파일 변경 시 작동
    branches:
      - main
  workflow_dispatch: # 수동 실행 버튼

# 1. 권한 설정: 로봇에게 저장소 쓰기 권한을 명시적으로 부여 (403 에러 및 인식 오류 방지)
permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # 히스토리 전체를 가져와 변경 사항 추적 안정화

      - name: DeepL English-Only Engine
        env:
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
        run: |
          TARGET_LANGS=("en")
          DEEPL_CODES=("EN-US")

          if [ ! -d "ko" ]; then
            echo "ko 폴더를 찾을 수 없습니다."
            exit 0
          fi

          # 2. ko 폴더 내의 모든 .md 파일 번역 (SUMMARY.md 포함)
          find ko -name "*.md" | while read file; do
            REL_PATH=${file#ko/}
            
            for i in "${!TARGET_LANGS[@]}"; do
              LANG=${TARGET_LANGS[$i]}
              CODE=${DEEPL_CODES[$i]}
              TARGET_FILE="$LANG/$REL_PATH"

              mkdir -p "$(dirname "$TARGET_FILE")"

              echo "Processing: $file -> $TARGET_FILE"

              # 'Next Market' 보호 태그 삽입
              ORIGINAL_CONTENT=$(cat "$file")
              PROTECTED_CONTENT=$(echo "$ORIGINAL_CONTENT" | sed 's/Next Market/<span translate="no">Next Market<\/span>/g')

              # DeepL API 호출
              # preserve_formatting=1을 사용하여 마크다운 구조(공백, 줄바꿈)를 더 엄격하게 보호합니다.
              RESPONSE=$(curl -s -X POST "https://api-free.deepl.com/v2/translate" \
                -H "Authorization: DeepL-Auth-Key $DEEPL_API_KEY" \
                --data-urlencode "text=$PROTECTED_CONTENT" \
                -d "source_lang=KO" \
                -d "target_lang=$CODE" \
                -d "tag_handling=html" \
                -d "preserve_formatting=1")

              TRANSLATED_RAW=$(echo "$RESPONSE" | jq -r '.translations[0].text // empty')

              if [ -n "$TRANSLATED_RAW" ] && [ "$TRANSLATED_RAW" != "null" ]; then
                # 보호 태그 제거 및 최종 저장
                FINAL_CONTENT=$(echo "$TRANSLATED_RAW" | sed 's/<span translate="no">Next Market<\/span>/Next Market/g')
                
                # 깃북 인식률을 높이기 위해 프론트매터(---)가 깨졌는지 확인 후 보정하는 로직 추가 가능
                echo "$FINAL_CONTENT" > "$TARGET_FILE"
              else
                echo "번역 실패: $file ($CODE) - 응답: $RESPONSE"
              fi
            done
          done

      - name: Sync SUMMARY.md
        run: |
          # 목차 파일은 번역 여부와 상관없이 항상 en 폴더의 최상단에 존재해야 깃북 사이드바가 나타납니다.
          if [ -f "ko/SUMMARY.md" ]; then
            mkdir -p en
            cp "ko/SUMMARY.md" "en/SUMMARY.md"
            echo "SUMMARY.md synced to en/"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add en/
          # Unifi 스타일처럼 깔끔한 커밋 메시지 적용
          git commit -m "docs: sync english documentation from korean source" || echo "No changes to commit"
          git push origin main
